<!doctype html>
<html>
<head>
    <title>flask webFridge</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="{{ url_for('static', filename='socket.io.min.js') }}"> </script>
    <!---
    <script src="{{ url_for('static', filename='plotly-latest.min.js') }}"> </script>
    <script src="{{ url_for('static', filename='snippet-javascript-console.min.js') }}"> </script>
    <script src="{{ url_for('static', filename='snippet-javascript-console.min.js') }}"> </script>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='mainpage.css') }}">
    -->
    <style type="text/css">
        * {margin: 0; padding: 0}
        .datatable{
            border: 1px solid black;
            border-collapse: collapse;
            margin-left: 50px;
        }
        th, td {
            border: 1px solid black;
            border-collapse: collapse;
        }
        .state{
            margin-left: 0px;
        }

        .column {
            float: left; 
            width: 300px;
            padding: 0px;
            margin-left: 10px;
        }
        .column2 {
            float: left;
            width: 60%; 
        }

        /* Clear floats after the columns */
        .row:after {
            content: "";
            display: table;
            clear: both;
        }
        .checkboxes
           margin-left: 50px;
        }
        .size-12 {
            font-size: 18px;
        }
        input[type=checkbox][disabled]{
            outline:2px solid red;
        }
        .js-plotly-plot .plotly .modebar {
            left: 50%;
            transform: translateX(-50%);
        }
    </style>
</head>

<body>
    <div class="row">
        <div class="column">
            <div id="loading" style="margin-left:50px">Loading</div>
            <table id="datatable" class="datatable"> </table>
            <br>
            <div class="checkboxes">
            <input type="checkbox"  id="manual"
                                    onclick="clicked_switch(this);">
                Manual<br>
            <br>
            <input type="checkbox"  id="hp" class="switch"
                                    onclick="clicked_switch(this);">
                Pump On<br>
            <br>
            <input type="checkbox"  id="hs" class="switch"
                                    onclick="clicked_switch(this);">
                Switch On<br>
            <br>
            <div id="compressor_div">
                <input type="checkbox"  id="compressor" class="switch"
                    onclick="console.log(this.checked);">
                Compressor<br>
                </div>
            <select id="state" class="state"
                               onchange="select_state(this);">
                 {% for state in states %}
                 <option> {{state}} </option>
                 {% endfor %}
            </select>
            <br>
            <br>
            <div> 
            Recycle Hour:
            <input id = "hour" type="number" class="size-12" value="{{recycle_hour}}" min="-1" max="23" onchange="socket.emit('set_recycle_hour', this.value);">
            </div>
            <br>
            <div id="next">
                Next Time: {{next_recycle_time}}
            </div>
            <br>
            <div id="download_hyperlink">
            <a id="download" href="/logfile"> Download log </a>
            </div>
            <input type="file">
            </div>
        </div>
        <div class="column2">
            <h4 style="margin-bottom=0"> Room: {{room}}  Name: {{name}}</h4>
            <div id="mainGraph" class="mainGraph" > </div>
            <div id="console" class="console">
                <textarea style="color:white;width:90%;margin:0px;background:black;height:100px" class="TextInput" autocomplete="off" readonly="true" onclick="" onchange="console.log('console change');"> Hello
            </textarea>
        </div>
    </div>

    <!-- allows page refresh every 10 seconds -->
    <!meta http-equiv="refresh" content="10" >

</body>

    <!--
    <script type="text/javascript" src="//code.jquery.com/jquery-1.4.2.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.5/socket.io.min.js"></script>
    -->
    <script type="text/javascript" charset="utf-8">
        /**
         * Set Select Box Selection By Text
         * @param eid Element ID
         * @param eval Element Index
         */
        function setSelectBoxByText(eid, etxt) {
            var eid = document.getElementById(eid);
            for (var i = 0; i < eid.options.length; ++i) {
                if (eid.options[i].text === etxt)
                    eid.options[i].selected = true;
            }
        }
        function select_state(data) {
            // console.log(data);
            // console.log(data.selectedIndex);
            new_state = data.options[data.selectedIndex].text;
            console.log('selected state: '+new_state);
            update_manual(new_state);
            socket.emit('state', new_state);
        }
        function update_manual(data) {
            if (data=="manual") {
                var eid = document.getElementById("manual");
                eid.checked = true;
            } else {
                var eid = document.getElementById("manual");
                eid.checked = false;
                }
            switches = document.getElementsByClassName("switch");
            for (i=0; i<switches.length; i++) {
                switches[i].disabled = !eid.checked;
                }
            }
        function change_state(state) {
            update_manual(state);
            }
        function update_switches(table_names, table_data) {
            switches = document.getElementsByClassName("switch");
            for (i=0; i<switches.length; i++) {
                switch_name = switches[i].id;
                if (table_data[switch_name]>0) {
                   switches[i].checked = true;
                } else {
                   switches[i].checked = false;
                }
            }
        }
        function clicked_switch(checkbox) {
            console.log('clicked '+checkbox.id + ' state: '+checkbox.checked);
            if (checkbox.id == 'manual') {
                setSelectBoxByText("state", 'manual');
                socket.emit('state', 'manual');
                update_manual('manual');
                //  Force the checkbox to be true all the time
                checkbox.checked = true
            } else {
                socket.emit('switch', {name: checkbox.id,
                                    state: checkbox.checked});
            }

        }
        function update_recycle_time() {
            console.log('update_recycle_time not implemented');
        }
        function update_log_filename(name) {
            document.getElementById('download').innerHTML = 'Download '+name;
        }
        var graphs = {{graphJSON | safe}};
        Plotly.newPlot('mainGraph',graphs.data,graphs.layout || {});
        // console.log(graphs)

        // Connect to the Socket.IO server.
        var socket = io.connect('http://'  + document.domain + ':' + location.port );
        // Event handler for new connections.
        // The callback function is invoked when a connection with the
        // server is established.
        var names;
        socket.on('connect', function(msg) {
            console.log('connected msg:', msg);
            //console.log(typeof(msg));
            names = msg;
            if (msg) {
                update_log_filename(names['log_filename']);
                socket.emit('my_event','');
                console.log('send my_event message');
                // document.getElementById('download').innerHTML = names['log_filename'];
            }
        });
        var currentstate;
        socket.on('fridge_state', function(data){
            // console.log(data);
            // console.log('currentstate', currentstate, currentstate!=data);
            if (currentstate != data) {
                currentstate = data;
                console.log('Update state to :', currentstate);
                setSelectBoxByText("state", data);
                update_manual(data);
                }
            });
        var zoom_graph;
        socket.on('zoom_graph', function(data) {
            console.log('zoom_graph')
            zoom_graph = JSON.parse(data)
            // Plotly.update('mainGraph', zoom_graph.graph);
            Plotly.react('mainGraph', zoom_graph.data, zoom_graph.layout);
            // Plotly.newPlot('mainGraph', zoom_graph.data, zoom_graph.layout);
            });
        socket.on('update_recycle', function(data) {
            console.log('update_recycle info')
            data = JSON.parse(data)
            console.log(data)
            update_recycle_time(data['next_time']);
            document.getElementById('hour').value = int(data['recycle_hour']);
            document.getElementById('next').innerHTML = 'Next Time: ' + data['next_time'];
            });
        socket.on('new_data', function(data){
            //console.log("madeeee it");
            //console.log(data)
            var table = document.getElementById('datatable');
            table.innerHTML="";
            var idx = 0;
            // Update table
            var sensor_names = names['graph'];
            var graph = data['graph'];
            var table_data = data['table'];
            var table_names = names['table'];
            // console.log(table_data);
            // console.log(table_names);
            for (var name in table_names) {
                var tr = document.createElement('tr');
                var td = document.createElement('td');
                td.width=75
                td.innerHTML = table_names[name];
                tr.appendChild(td);
                td = document.createElement('td');
                td.align = "right"
                td.innerHTML = parseFloat(table_data[table_names[name]]).toFixed(3);
                td.width=75
                tr.appendChild(td);
                table.appendChild(tr);
                idx = idx + 1;
            }
            // Update graph
            var list = [];
            for (var i = 0; i < sensor_names.length; i++) {
                list.push(i);
            }
            // update = {x:[data['x'][0]], y:[ data['y'][0] ]}
            // Plotly.extendTraces('mainGraph', update, [1]);
            // console.log(graph['x'][0][0])
            Plotly.extendTraces('mainGraph', graph, list);
            update_switches(table_names, table_data);
            //  Update time
            var d = new Date();
            var n = d.toLocaleString();
            document.getElementById("loading").innerHTML = ''+n;
        });
        update_recycle_time()
        setSelectBoxByText('state', 'manual');
        update_manual('manual');
        document.getElementById("compressor_div").style.display = "none"
        mainGraph.on('plotly_relayout',
            function(eventdata){
                console.log(eventdata);
                if ("xaxis.range[0]" in eventdata) {
                    socket.emit('zoom', eventdata);
                    /*
                    alert( 'ZOOM!' + '\n\n' +
                        'Event data:' + '\n' +
                        JSON.stringify(eventdata) + '\n\n' +
                        'x-axis start:' + eventdata['xaxis.range[0]'] + '\n' +
                        'x-axis end:' + eventdata['xaxis.range[1]'] );
                    */
                    }
                else if ("xaxis.showspikes" in eventdata) {
                    socket.emit('unzoom', eventdata);
                }
        });
        // var eid = document.getElementById("hp");
        // eid.checked = true;
    </script>

</html>
